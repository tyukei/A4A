name: Auto Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version
        id: bump_version
        run: |
          # Get current version
          CURRENT_VERSION=$(grep '^version =' pyproject.toml | cut -d '"' -f 2)
          echo "Current version: $CURRENT_VERSION"
          
          # Increment patch version (last digit)
          NEW_VERSION=$(python3 -c "v = '$CURRENT_VERSION'.split('.'); v[-1] = str(int(v[-1]) + 1); print('.'.join(v))")
          echo "New version: $NEW_VERSION"
          
          # Update pyproject.toml
          sed -i 's/^version = "'$CURRENT_VERSION'"/version = "'$NEW_VERSION'"/' pyproject.toml
          
          echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add pyproject.toml
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.VERSION }} [skip ci]"
          git push

      - name: Generate AI Summary
        id: ai_summary
        if: env.GEMINI_API_KEY != ''
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PRs or Commits
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          # Try getting PRs
          if [ -n "$LAST_TAG" ]; then
            CONTENT_LIST=$(gh pr list --state merged --base main --limit 20 --json title --template '{{range .}}- {{.title}}\n{{end}}')
          else
            CONTENT_LIST=$(gh pr list --state merged --limit 10 --json title --template '{{range .}}- {{.title}}\n{{end}}')
          fi

          # Fallback to commits if no PRs found
          if [ -z "$CONTENT_LIST" ]; then
            echo "No PRs found. Falling back to commit messages."
            if [ -n "$LAST_TAG" ]; then
              CONTENT_LIST=$(git log ${LAST_TAG}..HEAD --oneline --no-merges | head -n 20)
            else
              CONTENT_LIST=$(git log --oneline --no-merges | head -n 10)
            fi
          fi
          
          if [ -z "$CONTENT_LIST" ]; then
            echo "SUMMARY=No significant changes found." >> $GITHUB_OUTPUT
            exit 0
          fi

          # Call Gemini API using a heredoc to avoid quoting issues
          export CONTENT_LIST="$CONTENT_LIST"
          SUMMARY=$(python3 << 'EOF'
          import os, json, http.client
          api_key = os.getenv('GEMINI_API_KEY')
          content = os.getenv('CONTENT_LIST')
          prompt = f'Following is a list of changes (Pull Requests or Commits). Please write a concise, friendly, and professional "What\'s New" summary for release notes in Japanese. Focus on the value to the user. Keep it under 5 bullet points.\n\n{content}'

          try:
              conn = http.client.HTTPSConnection('generativelanguage.googleapis.com')
              headers = {'Content-Type': 'application/json'}
              payload = {
                  'contents': [{'parts': [{'text': prompt}]}]
              }
              conn.request('POST', f'/v1beta/models/gemini-2.5-flash:generateContent?key={api_key}', json.dumps(payload), headers)
              res = conn.getresponse()
              if res.status != 200:
                  print(f"API Error: {res.status} {res.reason}")
                  exit(0)
              
              data = json.loads(res.read().decode())
              text = data['candidates'][0]['content']['parts'][0]['text']
              print(text.strip())
          except Exception as e:
              print(f"Error during AI generation: {str(e)}")
          EOF
          )
          
          # Escape newlines for output
          SUMMARY="${SUMMARY//'%'/'%25'}"
          SUMMARY="${SUMMARY//$'\n'/'%0A'}"
          SUMMARY="${SUMMARY//$'\r'/'%0D'}"
          echo "SUMMARY=$SUMMARY" >> $GITHUB_OUTPUT
        shell: bash {0}
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump_version.outputs.VERSION }}
          body: |
            ## âœ¨ What's New
            ${{ steps.ai_summary.outputs.SUMMARY || 'AI summary not available.' }}

          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
