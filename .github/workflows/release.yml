name: Auto Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version
        id: bump_version
        run: |
          # Get current version
          CURRENT_VERSION=$(grep '^version =' pyproject.toml | cut -d '"' -f 2)
          echo "Current version: $CURRENT_VERSION"
          
          # Increment patch version (last digit)
          NEW_VERSION=$(python3 -c "v = '$CURRENT_VERSION'.split('.'); v[-1] = str(int(v[-1]) + 1); print('.'.join(v))")
          echo "New version: $NEW_VERSION"
          
          # Update pyproject.toml
          sed -i 's/^version = "'$CURRENT_VERSION'"/version = "'$NEW_VERSION'"/' pyproject.toml
          
          echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add pyproject.toml
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.VERSION }} [skip ci]"
          git push

      - name: Generate AI Summary
        id: ai_summary
        if: ${{ secrets.GEMINI_API_KEY != '' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get PRs merged since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            PR_LIST=$(gh pr list --state merged --limit 10 --json title,body --template '{{range .}}- {{.title}}\n{{end}}')
          else
            PR_LIST=$(gh pr list --state merged --base main --limit 20 --json title,body --template '{{range .}}- {{.title}}\n{{end}}')
          fi
          
          if [ -z "$PR_LIST" ]; then
            echo "SUMMARY=No recent PRs found." >> $GITHUB_OUTPUT
            exit 0
          fi

          # Call Gemini API
          # Pass PR_LIST as an environment variable to the python script
          export PR_LIST="$PR_LIST"
          SUMMARY=$(python3 -c "
          import os, json, http.client
          api_key = os.getenv('GEMINI_API_KEY')
          pr_list = os.getenv('PR_LIST')
          prompt = f'Following is a list of merged pull requests. Please write a concise, friendly, and professional \"What\'s New\" summary for release notes in Japanese. Focus on the value to the user. Keep it under 5 bullet points.\n\n{pr_list}'
          
          conn = http.client.HTTPSConnection('generativelanguage.googleapis.com')
          headers = {'Content-Type': 'application/json'}
          payload = {
              'contents': [{'parts': [{'text': prompt}]}]
          }
          conn.request('POST', f'/v1beta/models/gemini-1.5-flash:generateContent?key={api_key}', json.dumps(payload), headers)
          res = conn.getresponse()
          data = json.loads(res.read().decode())
          try:
              text = data['candidates'][0]['content']['parts'][0]['text']
              print(text.strip())
          except:
              print('AI summary generation failed.')
          " )
          
          # Escape newlines for output
          SUMMARY="${SUMMARY//'%'/'%25'}"
          SUMMARY="${SUMMARY//$'\n'/'%0A'}"
          SUMMARY="${SUMMARY//$'\r'/'%0D'}"
          echo "SUMMARY=$SUMMARY" >> $GITHUB_OUTPUT
        shell: bash {0}
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump_version.outputs.VERSION }}
          body: |
            ## âœ¨ What's New
            ${{ steps.ai_summary.outputs.SUMMARY || 'AI summary not available.' }}

          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
